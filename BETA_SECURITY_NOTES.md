# ベータ運用 セキュリティ注意事項

## ⚠️ 重要：ベータ版の制限事項

### 現在の実装状態

#### ✅ 実装済み
- JWT認証
- パスワードハッシュ化（bcrypt）
- HTTPS通信（Railway/Vercel）
- SQL injection対策（Prisma ORM使用）

#### ⚠️ 未実装（本番前に対応必須）
- **API Keyの暗号化保存**
  - 現状：平文でデータベースに保存
  - 影響：データベースが漏洩した場合、外部APIキーも漏洩
  - 対策：ベータ期間中はテスト用APIキーのみ使用
  
- **Rate Limiting**
  - 現状：なし
  - 影響：API乱用の可能性
  - 対策：ベータ期間中は少数顧客のみ

- **監査ログ**
  - 現状：最小限のログのみ
  - 影響：セキュリティインシデント追跡が困難
  - 対策：重要操作は手動記録

---

## ベータ運用時の推奨対応

### 1. APIキーの取り扱い

```
❌ やってはいけないこと:
- 本番用のIndeed/求人ボックスAPIキーを登録
- 課金上限なしのAPIキーを使用
- 顧客に直接APIキーを入力させる

✅ ベータ期間中の推奨:
- テスト環境のAPIキーを使用
- APIキーに月額上限を設定
- 管理者のみがAPIキーを設定
- ダミーコネクタで動作確認
```

### 2. データアクセス制限

```
✅ ベータテスト顧客の選定:
- 信頼できる企業のみ
- NDA締結済み企業
- テストデータのみ使用を理解している企業

❌ 避けるべき:
- 不特定多数への公開
- 実際の求職者データの投入
- 機密性の高い求人情報
```

### 3. 環境変数管理

```bash
# ❌ GitHubにコミットしない
.env
.env.local
.env.production

# ✅ 必ず.gitignoreに追加
echo ".env" >> .gitignore
echo ".env.local" >> .gitignore
```

### 4. バックアップ

```bash
# 毎日実行推奨
# PostgreSQLバックアップ
pg_dump $DATABASE_URL > backup_$(date +%Y%m%d).sql

# または Railway CLIで
railway run pg_dump > backup.sql
```

---

## インシデント対応手順

### APIキーが漏洩した場合

1. **即座に実行**
   ```
   - 該当APIキーを無効化（各サービスのダッシュボード）
   - 新しいAPIキーを発行
   - 環境変数を更新
   - アプリケーション再起動
   ```

2. **影響確認**
   ```
   - API使用履歴を確認
   - 不正利用の有無をチェック
   - 課金状況を確認
   ```

3. **再発防止**
   ```
   - 漏洩経路の特定
   - セキュリティ対策の見直し
   ```

### データベースが漏洩した場合

1. **即座に実行**
   ```
   - データベース接続を遮断
   - すべてのJWTトークンを無効化
   - パスワードリセットを全ユーザーに要請
   ```

2. **影響範囲の確認**
   ```
   - どのデータが含まれていたか
   - 個人情報の有無
   - 外部APIキーの有無
   ```

---

## 監視すべき項目

### 毎日確認
- [ ] Railwayのエラーログ
- [ ] APIの異常な使用量
- [ ] データベースのサイズ増加
- [ ] メール送信数

### 週次確認
- [ ] API使用料金
- [ ] バックアップの取得
- [ ] セキュリティアップデートの確認

---

## 本番移行前の必須対応

ベータ期間終了後、本番運用前に以下を実装：

```
1. API Key暗号化（at-rest encryption）
2. Rate Limiting（express-rate-limit等）
3. WAF設定（Cloudflare等）
4. 監査ログ（全CRUD操作）
5. 2FA（二要素認証）
6. セキュリティヘッダー強化
7. 定期的なセキュリティ監査
8. GDPR/個人情報保護法対応
```

---

## 連絡先

セキュリティインシデント発生時：
- [緊急連絡先]
- [担当者メール]

